(function($){$(document).ready(function(){$("#generaterandom").click(generateRandomTable);$("#startsimulate").click(function(){if(SIMULATION_STARTED){if(confirm("该页面将进行刷新，当前页面所有数据都会丢失！\n"+"页面刷新成功后你需要重新点击该按钮产生数据. \n"+"继续?")){location.reload()}}else{start_simulate();jQuery("#summary").html(collect_summary());scrollAnimate()}})})})(jQuery);LOGTYPES={"disabled":0,"console":1,"alert":2};logtype=LOGTYPES.console;LOG={"warn":function(){var msg=jQuery.makeArray(arguments).join("\n");switch(logtype){case LOGTYPES.alert:msg="Warning:\n\n"+msg;alert(msg);break;case LOGTYPES.console:console.warn(msg);break}},"error":function(){var msg=jQuery.makeArray(arguments).join("\n");switch(logtype){case LOGTYPES.alert:msg="Error:\n\n"+msg;alert(msg);break;case LOGTYPES.console:console.error(msg);break}},"debug":function(){var msg=jQuery.makeArray(arguments).join("\n");switch(logtype){case LOGTYPES.alert:msg="Debug:\n\n"+msg;alert(msg);break;case LOGTYPES.console:console.debug(msg);break}},"log":function(){var msg=jQuery.makeArray(arguments).join("\n");switch(logtype){case LOGTYPES.alert:msg="Log:\n\n"+msg;alert(msg);break;case LOGTYPES.console:console.log(msg);break}}};CLOCK=0;SIMULATION_STARTED=false;AllCustomers=[];TellerState={"Free":0,"Busy":1};CustomerState={"WaitingForService":0,"InService":1,"FinishedJob":2};SystemStateLog=[];SystemStateLogTypes={"Customer":{"Enter":"customer_enter","GetService":"customer_getservice","Exit":"customer_exit"},"TellerManager":{"CreateTeller":"tellermanager_create_teller","Increase":"tellermanager_increase","ListFreeTellers":"tellermanager_listfree"},"Teller":{"StateBusy":"teller_state_busy","StateFree":"teller_state_free"},"Queue":{"Log":"queue_log"},"NumberingMachine":{"Increase":"numberingmachine_increase"},"SimulationEngine":{"Start":"simulation_start","Finish":"simulation_finish","Log":"simulation_log"}};function SystemState_log(type,msg){if(typeof(SystemStateLog[CLOCK])=="undefined"){SystemStateLog[CLOCK]=[]}var newmsg;if(typeof msg=="object"){if(msg.hasOwnProperty("getAll")){newmsg=RenderingEngine.renderQueue(msg)}else{newmsg=msg}}else{newmsg=msg}SystemStateLog[CLOCK][SystemStateLog[CLOCK].length]={"message":newmsg,"type":type,"clock":CLOCK}}function getRandomInt(min,max){return Math.floor(Math.random()*(max-min+1))+min}function generateRandomTable(){var table_str="",prev_time=0,samp_time=0,duration=$("#duration").val(),customer_count=getRandomInt(Math.floor(duration/3),duration),max_time;for(var i=1;i<=customer_count;i++){max_time=prev_time+5;if(max_time>duration-5){max_time=duration-5}samp_time=getRandomInt(prev_time,max_time);if(prev_time==samp_time){continue}table_str+="\n"+samp_time;if(samp_time==duration){break}prev_time=samp_time}$("#arrivaltable").val(table_str.trim())}TellerManager={"tellers":[],"lastnumber":0,"createTeller":function(){LOG.debug("called TellerManager.createTeller()");var teller=new Teller(this.tellers.length+1);this.tellers.push(teller);SystemState_log(SystemStateLogTypes.TellerManager.CreateTeller,"服务人员就绪");SystemState_log(SystemStateLogTypes.SimulationEngine.Log,"服务人员ID: "+teller.tellerid)},"getTeller":function(tellerid){LOG.debug("called TellerManager.getTeller("+tellerid+")");if(typeof(this.tellers[tellerid-1])!="undefined"){return this.tellers[tellerid-1]}else{return false}},"getFreeTellers":function(){LOG.debug("called TellerManager.getFreeTellers()");var result=[];this.tellers.forEach(function(teller1){if(teller1.state==TellerState.Free){result.push(teller1)}});return result},"getWaitingNumbers":function(){LOG.debug("called TellerManager.getWaitingNumbers()");var result=[];this.tellers.forEach(function(teller1){if(teller1.state==TellerState.Free){result.push(teller1.customerid)}});return result},"searchForWaitingCustomer":function(customerid){LOG.debug("called TellerManager.searchForWaitingCustomer("+customerid+")");var waitingNumbers=this.getWaitingNumbers();return(waitingNumbers.indexOf(customerid)>=0)},"increaseNumber":function(){LOG.debug("called TellerManager.increaseNumber()");SystemState_log(SystemStateLogTypes.TellerManager.Increase,"叫号器呼叫新用户");SystemState_log(SystemStateLogTypes.SimulationEngine.Log,"新号码: "+(this.lastnumber+1));return++this.lastnumber}};NumberingMachine={"number":0,"getNumber":function(){LOG.debug("called NumberingMachine.getNumber()");return this.number},"increase":function(){LOG.debug("called NumberingMachine.increase()");SystemState_log(SystemStateLogTypes.NumberingMachine.Increase,"发号器产生新号码");SystemState_log(SystemStateLogTypes.SimulationEngine.Log,"新号码: "+(this.number+1));return++this.number}};function Teller(id){LOG.debug("called new Teller("+id+")");this.tellerid=id;this.state=TellerState.Free;this.customerid=TellerManager.increaseNumber();this.lastChangeTime=CLOCK;this.totalFreeTime=0;this.totalBusyTime=0;this.setStateBusy=function(customerid){if(this.state==TellerState.Busy){LOG.error("Teller is already busy.");return false}this.totalFreeTime+=(CLOCK-this.lastChangeTime);this.lastChangeTime=CLOCK;this.state=TellerState.Busy;this.customerid=customerid;SystemState_log(SystemStateLogTypes.Teller.StateBusy,"服务人员开始服务");SystemState_log(SystemStateLogTypes.SimulationEngine.Log,"服务人员ID: "+this.tellerid);SystemState_log(SystemStateLogTypes.SimulationEngine.Log,"被服务顾客ID: "+customerid);SystemState_log(SystemStateLogTypes.SimulationEngine.Log,"总闲暇时间: "+this.getTotalFreeTime()+" 分钟.");SystemState_log(SystemStateLogTypes.SimulationEngine.Log,"总服务时间: "+this.getTotalBusyTime()+" 分钟.");SystemState_log(SystemStateLogTypes.TellerManager.ListFreeTellers,RenderingEngine.renderTellerArray(TellerManager.getFreeTellers()));return true};this.setStateFree=function(){if(this.state==TellerState.Free){LOG.error("Teller is already free.");return false}this.totalBusyTime+=(CLOCK-this.lastChangeTime);this.lastChangeTime=CLOCK;this.state=TellerState.Free;this.customerid=TellerManager.increaseNumber();SystemState_log(SystemStateLogTypes.Teller.StateFree,"服务人员开始空闲。");SystemState_log(SystemStateLogTypes.SimulationEngine.Log,"服务人员ID: "+this.tellerid);SystemState_log(SystemStateLogTypes.SimulationEngine.Log,"现在能接收的顾客ID: "+this.customerid);SystemState_log(SystemStateLogTypes.SimulationEngine.Log,"总空闲时间: "+this.getTotalFreeTime()+" 分钟");SystemState_log(SystemStateLogTypes.SimulationEngine.Log,"总忙碌时间: "+this.getTotalBusyTime()+" 分钟");SystemState_log(SystemStateLogTypes.TellerManager.ListFreeTellers,RenderingEngine.renderTellerArray(TellerManager.getFreeTellers()));return true};this.getTotalFreeTime=function(){var curr=0;if(this.state==TellerState.Free){curr=CLOCK-this.lastChangeTime}return curr+this.totalFreeTime};this.getTotalBusyTime=function(){var curr=0;if(this.state==TellerState.Busy){curr=CLOCK-this.lastChangeTime}return curr+this.totalBusyTime}}function Customer(){this.customerid=NumberingMachine.increase();AllCustomers[this.customerid]=this;this.tellerid=0;this.state=CustomerState.WaitingForService;this.enterTime=CLOCK;this.inServiceTime=null;this.exitTime=null;this.setStateInService=function(){this.inServiceTime=CLOCK;this.state=CustomerState.InService;SystemState_log(SystemStateLogTypes.Customer.GetService,"顾客得到服务");SystemState_log(SystemStateLogTypes.SimulationEngine.Log,"顾客ID: "+this.customerid);SystemState_log(SystemStateLogTypes.SimulationEngine.Log,"顾客等待时间总长: "+this.getTotalWaitTime())};this.setStateFinishedJob=function(){this.exitTime=CLOCK;this.state=CustomerState.FinishedJob;SystemState_log(SystemStateLogTypes.Customer.Exit,"顾客离开银行");SystemState_log(SystemStateLogTypes.SimulationEngine.Log,"顾客ID: "+this.customerid);SystemState_log(SystemStateLogTypes.SimulationEngine.Log,"顾客银行总停留时间: "+(this.exitTime-this.enterTime)+"分钟")};this.getTotalWaitTime=function(){return this.inServiceTime-this.enterTime};SystemState_log(SystemStateLogTypes.Customer.Enter,"顾客进入银行");SystemState_log(SystemStateLogTypes.SimulationEngine.Log,"顾客ID: "+this.customerid)}CustomerQueue=new Queue();function start_simulate(){SIMULATION_STARTED=true;SystemState_log(SystemStateLogTypes.SimulationEngine.Start,"开始模拟演示");var duration=Number($("#duration").val()),arrivaltable=$("#arrivaltable").val(),responsetimeave=Number($("#responsetimeave").val()),tellerscount=Number($("#tellerscount").val());arrivaltable=str_replace("\r","\n",arrivaltable);arrivaltable=str_replace("\n\n","\n",arrivaltable);arrivaltable=explode("\n",arrivaltable);var arrivalTableQueue=new Queue();for(var i=0;i<arrivaltable.length;i++){arrivalTableQueue.enqueue(arrivaltable[i])}for(var tellerid=1;tellerid<=tellerscount;tellerid++){TellerManager.createTeller()}var customer;for(CLOCK=0;CLOCK<=duration;CLOCK++){var new_arrival=arrivalTableQueue.peek();if(new_arrival==CLOCK){customer=new Customer();CustomerQueue.enqueue(customer);SystemState_log(SystemStateLogTypes.Queue.Log,CustomerQueue);arrivalTableQueue.dequeue()}TellerManager.tellers.forEach(function(teller1){if(teller1.state==TellerState.Busy){if(typeof(AllCustomers[teller1.customerid])=="undefined"){LOG.error("Critical: customer is not defined in AllCustomers. customerid="+teller1.customerid+", tellerid="+teller1.tellerid);return}var customer1=AllCustomers[teller1.customerid];var customer1_inservice_time=CLOCK-customer1.inServiceTime;if(customer1_inservice_time==responsetimeave){customer1.setStateFinishedJob();teller1.setStateFree()}else if(customer1_inservice_time>responsetimeave){LOG.error("customer insevice wait time is greater than average response time"+customer1_inservice_time)}}});while(true){var last_customer=CustomerQueue.peek();if(typeof(last_customer)=="undefined"){break}var last_customer_can_get_service=TellerManager.searchForWaitingCustomer(last_customer.customerid);if(last_customer_can_get_service){customer=CustomerQueue.dequeue();var freeTellers=TellerManager.getFreeTellers();var SelectedfreeTeller;for(var freeTellerC=0;freeTellerC<freeTellers.length;freeTellerC++){if(freeTellers[freeTellerC].customerid==customer.customerid){SelectedfreeTeller=freeTellers[freeTellerC];break}}customer.tellerid=SelectedfreeTeller.tellerid;customer.setStateInService();SystemState_log(SystemStateLogTypes.Queue.Log,CustomerQueue);var theTeller=TellerManager.getTeller(customer.tellerid);theTeller.setStateBusy(customer.customerid)}else{break}}}SystemState_log(SystemStateLogTypes.SimulationEngine.Finish,"模拟演示结束");RenderingEngine.render(SystemStateLog);jQuery("#results").html(RenderingEngine.getRenderedOutput());jQuery("#animateCustomerQueue").html(RenderingEngine.getRenderedOutput())}Statistics={"customers":[],"tellers":[]};function collect_summary(){var result="";result+=collect_summary_customers();result+=collect_summary_tellers();result+=collect_summary_overall();return result}function collect_summary_customers(){var result="<table>";result+="<tr>"+"<th>顾客ID</th>"+"<th>到达时间</th>"+"<th>离开时间</th>"+"<th>等待时长</th>"+"</tr>";for(var i=0;i<AllCustomers.length;i++){var customer=AllCustomers[i];if(typeof customer!="object"){continue}result+="<tr>";result+="<td>"+customer.customerid+"</td>";Statistics.customers[customer.customerid]={};result+="<td>"+customer.enterTime+"</td>";Statistics.customers[customer.customerid].enterTime=customer.enterTime;result+="<td>"+customer.exitTime+"</td>";Statistics.customers[customer.customerid].exitTime=customer.exitTime;result+="<td>"+customer.getTotalWaitTime()+"</td>";Statistics.customers[customer.customerid].TotalWaitTime=customer.getTotalWaitTime();result+="</tr>"}result+="</table>";return result}function collect_summary_tellers(){var result="<table>";result+="<tr>"+"<th>员工ID</th>"+"<th>空闲时间</th>"+"<th>忙碌时间</th>"+"</tr>";for(var i=0;i<TellerManager.tellers.length;i++){var teller=TellerManager.tellers[i];if(typeof teller!="object"){continue}result+="<tr>";result+="<td>"+teller.tellerid+"</td>";Statistics.tellers[teller.tellerid]={};result+="<td>"+teller.getTotalFreeTime()+"</td>";Statistics.tellers[teller.tellerid].TotalFreeTime=teller.getTotalFreeTime();result+="<td>"+teller.getTotalBusyTime()+"</td>";Statistics.tellers[teller.tellerid].TotalBusyTime=teller.getTotalBusyTime();result+="</tr>"}result+="</table>";return result}function collect_summary_overall(){var sum_customer_wait=0,sum_teller_free=0,sum_teller_busy=0;var average_customer_wait=0,average_teller_free=0,average_teller_busy=0;for(var count_customer=1;count_customer<Statistics.customers.length;count_customer++){sum_customer_wait+=Statistics.customers[count_customer].TotalWaitTime}count_customer--;average_customer_wait=sum_customer_wait/count_customer;for(var count_teller=1;count_teller<Statistics.tellers.length;count_teller++){sum_teller_free+=Statistics.tellers[count_teller].TotalFreeTime;sum_teller_busy+=Statistics.tellers[count_teller].TotalBusyTime}count_teller--;average_teller_busy=sum_teller_busy/count_teller;average_teller_free=sum_teller_free/count_teller;var result="<ul>";result+="<li>顾客平均等待时间: "+average_customer_wait+"</li>"+"<li>员工平觉空闲时间: "+average_teller_free+"</li>"+"<li>员工平均忙碌时间: "+average_teller_busy+"</li>";result+="</ul>";return result}